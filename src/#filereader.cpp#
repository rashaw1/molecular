/*
 *
 *   PURPOSE: Implements filereader.hpp, a class for reading input files.
 *
 *   DATE           AUTHOR           CHANGES
 *   ==================================================================
 *   30/08/15       Robert Shaw      Original code.
 *
 */
 
 #include "filereader.hpp"
 #include "ioutil.hpp"
 #include "error.hpp"
 #include <algorithm>
#include <iostream> 

 // Class FileReader implementation

// Destructor
FileReader::~FileReader()
{
  if ( natoms!= 0 ) {
    delete[] geometry;
  }
}

// Match a token to a particular command
int FileReader::findToken(std::string t)
{
  // Get rid of extraneous spaces
  t.erase(std::remove(t.begin(), t.end(), ' '), t.end());
  
  // make t lowercase
  std::transform(t.begin(), t.end(), t.begin(), ::tolower);

  // Match it to a command
  int rval = 0;
  if (t == "charge") { rval = 1; }
  else if (t == "multiplicity") { rval = 2; }
  else if (t == "maxiter") { rval = 3; }
  else if (t == "precision") { rval = 4; }
  else if (t == "basis") { rval = 5; }
  else if (t == "geom") { rval = 6; std::cout << "Found geom.\n";}
  else if (t == "thrint") { rval = 7; }
  else if (t == "integral") { rval = 8; std::cout << "Found integral\n"; }
  else if (t == "memory") { rval = 9; }  
  else if (t == "print") { rval = 10; }
  else if (t == "direct") { rval = 11; }
  return rval;
}

// Read in the parameters from the input file
void FileReader::readParameters()
{
  // Set default values, in case none specified
  charge = 0;
  multiplicity = 1;
  maxiter = 50;
  precision = 1e-12;
  geomstart = 0; geomend = 0;
  thrint = 1e-12;
  memory = 100;
  direct = false;
  twoprint = false;

  // Read line by line and parse
  std::string line, token;
  size_t pos;
  int linecount = 0;
  while (std::getline(input, line)) {
    // Erase any comments
    pos = line.find('!');
    if (pos != std::string::npos){
      line.erase(pos, line.length());
    }

    // Tokenise
    pos = line.find(',');
    if(pos != std::string::npos){
      token = line.substr(0, pos);

      // Match token to command
      switch(findToken(token)){
      case 1: { // Charge
	charge = std::stoi(line.substr(pos+1, line.length()));
	break;
      }
      case 2: { // Multiplicity
	multiplicity = std::stoi(line.substr(pos+1, line.length()));
	break;
      }
      case 3: { // MaxIter
	maxiter = std::stoi(line.substr(pos+1, line.length()));
	break;
      }
      case 4: { // Precision
	precision = std::stod(line.substr(pos+1, line.length()));
	break;
      }
      case 5: { // Basis
	line.erase(0, pos+1);
	// Get rid of excess spaces
	line.erase(std::remove(line.begin(), line.end(), ' '), line.end());
	basis = line;
	break;
      }
      case 6: { // GeomStart
	geomstart = linecount + 1;
	geomend = geomstart-1;
	while(line != "geomend"){

	  std::cout << "Incrementing\n";
	  geomend++;
	}
	std::cout << geomend << "\n";
	break;
      }
      case 7: { // Thrint
	thrint = std::stod(line.substr(pos+1, line.length()));
	break;
      }
      case 8: { // Memory
	memory = std::stod(line.substr(pos+1, line.length()));
	break;
      }
      case 9: { // Integral directive
	line.erase(0, pos+1);
        // Tokenise the next bit
	pos = line.find(',');
	if(pos != std::string::npos){
	  token = line.substr(0, pos);
	  switch(findToken(token)){
	  case 10: { // Print the integrals, file specified
	    twoprint = true;
	    line.erase(0, pos+1);
	    line.erase(0, pos+1);
	    // Get rid of excess spaces
	    line.erase(std::remove(line.begin(), line.end(), ' '), line.end());
	    intfile  = line;
	    break;
	  }
	  default: { 
	    throw(Error("READIN", "Command " + token + " not found."));
	  }
	  }
	} else {
	  // Get rid of excess spaces
	  line.erase(std::remove(line.begin(), line.end(), ' '), line.end());
	  switch(findToken(line)){
	  case 10: { // Print the integrals to default file name
	    twoprint = true;
	    intfile = "twoints.out";
	    break;
	  }
	  case 11: { // Direct
	    direct = true;
	    break;
	  }
	  default: {
	    throw(Error("READIN", "Command " + line + " not found."));
	  }
	  }
	}
	break;
      }
      default: { // Unkown command issued
	throw(Error("READIN", "Command " + token + " not found."));
      }
      }
    }
    linecount++;
  }
  natoms = geomend - geomstart;
  std::cout << natoms << "\n";
}

void FileReader::readGeometry()
{
  // The array size will be geomend-geomstart
  if (natoms != 0){
    geometry = new std::string[natoms];
   
    // Rewind to beginning of file
    input.clear();
    input.seekg(0, std::ios::beg);
    std::string line;
    // Copy the geometry into the array
    for (int l = 0; l < geomend; l++){
      std::getline(input, line);
      if (l > geomstart - 1){
	geometry[l - geomstart] = line;
      }
    }
  } else {
    throw(Error("READGM", "Geometry not found.")); 
  }
}
